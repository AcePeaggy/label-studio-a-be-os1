name: "Build PyPI Nightly"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1-5'  # Run at midnight UTC Monday through Friday

jobs:
  calculate-version:
    name: "Calculate Version"
    runs-on: ubuntu-latest
    if: github.repository_owner == 'HumanSignal'
    outputs:
      version: ${{ steps.set-nightly-version.outputs.version }}
    steps:
      - name: Set nightly version
        id: set-nightly-version
        run: |
          set -e
          version=$(curl -s "https://raw.githubusercontent.com/HumanSignal/label-studio/refs/heads/${{ github.event.repository.default_branch }}/pyproject.toml" | grep '^version' | cut -d'"' -f2)
          version="${version%dev*}dev$(date +'%Y%m%d')"
          echo "version=${version}" >> $GITHUB_OUTPUT

  create-nightly-release:
    name: "Create Nightly Release"
    runs-on: ubuntu-latest
    if: github.repository_owner == 'HumanSignal'
    needs: calculate-version
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Get previous nightly release
        id: previous-nightly
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIT_PAT }}
          script: |
            const { repo, owner } = context.repo;
            try {
              const nightlyRelease = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag: 'nightly'
              });
              
              await github.rest.repos.deleteRelease({
                owner,
                repo,
                release_id: nightlyRelease.data.id
              });
              
              core.setOutput('tag_name', nightlyRelease.data.tag_name);
            } catch (error) {
              if (error.status === 404) {
                console.log('No previous nightly release found');
              } else {
                throw error;
              }
            }

      - name: Generate Changelog
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIT_PAT }}
          script: |
            const { repo, owner } = context.repo;
            const tags = await github.rest.repos.listTags({
              owner,
              repo,
              per_page: 100
            });
            const latestNonNightlyTag = tags.data.find(tag => tag.name !== 'nightly');
            const latestTag = tags.data[0].name;
            const message = `# Nightly Build

            This is an automated nightly build that is recreated every night with the latest changes from the \`${{ github.event.repository.default_branch }}\` branch.

            ## Installation

            You can install this nightly build by downloading the wheel package from the release assets and installing it:
            ```bash
            pip install label_studio-*-py3-none-any.whl
            ```

            ## Important Notes
            - This is a development build and may contain bugs or incomplete features
            - Use in production environments is not recommended
            - Please report any issues you encounter in our [GitHub Issues](https://github.com/${owner}/${repo}/issues)
            - This release is automatically recreated every night with the latest changes

            ## Changes
            Changes since ${latestTag}:
            https://github.com/${owner}/${repo}/compare/${latestTag}...nightly`;
            const fs = require('fs');
            fs.writeFileSync('${{ github.workspace }}-CHANGELOG.txt', message);

      - name: Create Nightly Release
        id: create_release
        uses: softprops/action-gh-release@v2.2.1
        with:
          token: ${{ secrets.GIT_PAT }}
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          tag_name: nightly
          name: "Nightly"
          generate_release_notes: false
          draft: false
          prerelease: true
          append_body: false

      - name: Delete release assets
        if: steps.create_release.outputs.id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIT_PAT }}
          script: |
            const { repo, owner } = context.repo;
            const release_id = '${{ steps.create_release.outputs.id }}';
            const assets = await github.rest.repos.listReleaseAssets({
              owner,
              repo,
              release_id
            });
            for (const asset of assets.data) {
              await github.rest.repos.deleteReleaseAsset({
                owner,
                repo,
                asset_id: asset.id
              });
            }

  build-pypi:
    name: "Build"
    if: github.repository_owner == 'HumanSignal'
    needs: [calculate-version, create-nightly-release]
    permissions:
      contents: write
    uses: ./.github/workflows/build_pypi.yml
    with:
      version: ${{ needs.calculate-version.outputs.version }}
      ref: ${{ github.ref_name }}
      upload_to_pypi: false
      release_type: nightly
      release-id: ${{ needs.create-nightly-release.outputs.release_id }}
    secrets: inherit